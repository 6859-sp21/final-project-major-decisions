<html>
  <head>
    <!-- Load d3.js -->
    <script src="lib/d3.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
  </head>
  <body id="wholeBody">
    <select id="selectButton"></select>
    <div id="zoomChart">
      <script>
        d3.csv("data/airlines_time_agg.csv", function (d) {
          return {
            year: +d.year,
            month: +d.month,
            date: new Date(+d.year, +d.month),
            carrier: d.carrier,
            carrier_name: d.carrier_name,
            arr_flights: +d.arr_flights,
            arr_del15: +d.arr_del15,
            carrier_ct: +d.carrier_ct,
            weather_ct: +d.weather_ct,
            nas_ct: +d.nas_ct,
            security_ct: +d.security_ct,
            late_aircraft_ct: +d.late_aircraft_ct,
            arr_cancelled: +d.arr_cancelled,
            arr_diverted: +d.arr_diverted,
            arr_delay: +d.arr_delay,
            carrier_delay: +d.carrier_delay,
            weather_delay: +d.weather_delay,
            nas_delay: +d.nas_delay,
            security_delay: +d.security_delay,
            late_aircraft_delay: +d.late_aircraft_delay,
          };
        }).then(function (data) {
          let airData = data;
          generateTimeChart(data);
        });

        function generateTimeChart(data) {
          let sortedData = data.sort((x, y) => d3.ascending(x.date, y.date));

          // need to set up
          let aggData = sortedData.filter((d) => d.carrier === "AS");

          let airlineCarriers = new Set(data.map((d) => d.carrier_name));

          // add the options to the button
          d3.select("#selectButton")
            .selectAll("myOptions")
            .data(airlineCarriers)
            .enter()
            .append("option")
            .text(function (d) {
              return d;
            })
            .attr("value", function (d) {
              return d;
            });

          // set the dimensions and margins of the graph
          let margin = { top: 10, right: 30, bottom: 30, left: 60 },
            width = 560 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

          // append the svg object to the body of the page
          let svg = d3
            .select("#zoomChart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr(
              "transform",
              "translate(" + margin.left + "," + margin.top + ")"
            );

          let x = d3
            .scaleTime()
            .domain(d3.extent(sortedData, (d) => d.date))
            .range([0, width])
            .nice();

          let xAxis = d3.axisBottom(x);
          let xAxisGroup = svg
            .append("g")
            .call(xAxis)
            .attr("transform", "translate(0," + height + ")");

          let y = d3
            .scaleLinear()
            .domain([
              0,
              d3.max(sortedData, function (d) {
                return Math.max(
                  d.carrier_ct,
                  d.weather_ct,
                  d.nas_ct,
                  d.security_ct,
                  d.late_aircraft_ct
                );
              }),
            ])
            .range([height, 0])
            .nice();

          let yAxis = d3.axisLeft(y);
          let yAxisGroup = svg.append("g").call(yAxis);

          let delayTypes = [
            "carrier_ct",
            "weather_ct",
            "nas_ct",
            "security_ct",
            "late_aircraft_ct",
          ];

          let color = d3.scaleOrdinal().domain(delayTypes).range(d3.schemeSet2);

          let stackGen = d3.stack().keys(delayTypes);
          let stackedData = stackGen(aggData);

          let area = d3
            .area()
            .x((d) => x(d.data.date))
            .y0((d) => y(d[0]))
            .y1((d) => y(d[1]));

          let layers = svg
            .selectAll("layers")
            .data(stackedData)
            .join("path")
            .attr("d", area)
            .attr("class", function (d) {
              return "delayLayers " + d.key;
            })
            .attr("fill", (d) => color(d.key));

          function updateChart(selectedCarrier, svg) {
            let filteredData = sortedData.filter(
              (d) => d.carrier_name === selectedCarrier
            );
            let filteredStack = stackGen(filteredData);
            console.log(filteredStack);
            svg.selectAll(".delayLayers").remove();

            svg
              .selectAll("layers")
              .data(filteredStack)
              .join("path")
              .attr("class", function (d) {
                return "delayLayers " + d.key;
              })
              .attr("fill", (d) => color(d.key))
              .attr("d",d3.area()
                .x((d) => x(d.data.date))
                .y0((d) => y(d[0]))
                .y1((d) => y(d[1]))
              );
          }

          d3.select("#selectButton").on("change", function (d) {
            selectedCarrier = this.value;
            updateChart(selectedCarrier, svg);
          });

          let highlight = function (event, d) {
            d3.selectAll(".delayLayers").style("opacity", 0.2); // lower opacity if not selected
            d3.select("path.delayLayers." + d).style("opacity", 1); // selected should have full opacity
          };

          let noHighlight = function (d) {
            d3.selectAll("path.delayLayers").style("opacity", 1);
          };

          let legendSize = 20;
          svg
            .selectAll("legend")
            .data(delayTypes)
            .enter()
            .append("rect")
            .attr("x", width*3/4)
            .attr("y", function (d, i) {
              return 10 + i * (legendSize + 5);
            })
            .attr("width", legendSize)
            .attr("height", legendSize)
            .style("fill", d => color(d))
            .on("mouseover", highlight)
            .on("mouseleave", noHighlight)

          svg
            .selectAll("labels")
            .data(delayTypes)
            .enter()
            .append("text")
            .attr("x", width*3/4 + legendSize * 1.2)
            .attr("y", function (d, i) {
              return 10 + i * (legendSize + 5) + legendSize / 2;
            })
            .style("fill", d => color(d))
            .text(d => d)
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .on("mouseover", highlight)
            .on("mouseleave", noHighlight)
        }
      </script>
    </div>
  </body>
</html>
